# 第24章 网络请求与远程资源
Ajax技术涉及发送服务器请求额外数据而不刷新页面，从而实现良好的用户体验。把Ajax技术推到历史舞台的关键技术是XMLHttpRequest(XHR)对象。这个技术主要是可以实现在不刷新页面的情况下从服务器获取数据，格式并不一定是XML。  
XHR对象的API被普遍认为比较难用，而Fetch API自从诞生以来就迅速成为了XHR更现代的替代标准。Fetch API支持promise和service worker，已经成为极其强大的Web开发工具。  
## 24.1 XMLHttpRequest对象
### 使用XHR
所有现代浏览器都通过XMLHttpRequest构造函数原生支持XHR对象。
```
let xhr = new XMLHttpRequest();
```
使用XHR对象首先要调用open()方法，这个方法接收3个参数：请求类型（"get"、"post"等）、请求URL，以及表示请求是否异步的布尔值（true表示异步，false表示同步）。  
同步和异步的区别是：如果是同步的，之后的JavaScript代码会等待服务器响应之后再继续执行；如果是异步的，之后的JavaScript代码可以先执行而不用一直等待服务器响应数据。  
这行代码向example.php发送了一个同步的GET请求，这里的URL是相对于当前代码所在页面的，也可以使用绝对URL。  
调用open()不会实际发送请求，只是为发送请求做好准备。
```
xhr.open("get","example.php",false);
```
要发送定义好的请求，必须调用send()方法，send()方法接收一个参数，是作为请求体发送的数据。如果不需要发送请求体，则必须传null，因为这个参数在某些浏览器中是必需的。调用send()之后，请求就会发送到服务器。
```
xhr.send(null);
```
收到响应后，XHR对象的以下属性会被填充上数据：
- responseText：作为响应体返回的文本。
- responseXML：如果响应的内容类型是“text/xml”或“application/xml”，那就是包含响应数据的XML DOM 文档。
- status：响应的HTTP状态。
- statusText：响应的HTTP状态描述。  

收到响应后，第一步要检查status属性以确保响应成功返回。一般来说，HTTP状态码为2xx表示成功。此时，responseText或responseXML属性中会有内容。如果HTTP状态码是304，则表示资源未修改过，是从浏览器缓存中直接拿取的。这也意味着响应有效。
```
if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
    console.log(xhr.responseText);
} else {
    console.log(`Request was unsuccessful: ${xhr.status}`);
}
```
为确定下一步该执行什么操作，最好检查status而不是statusText属性，因为后者已经被证实在跨浏览器的情况下不可靠。无论是什么响应内容类型，responseText属性时钟会保存响应体，而responseXML则对非XML数据是null。  
XHR对象有一个readyState属性，表示当前处在请求/响应过程的哪个阶段。
- 0：未初始化。尚未调用open()方法。
- 1：已打开。已调用open()方法，尚未调用send()方法。
- 2：已发送。已调用send()方法，尚未收到响应。
- 3：接收中。已收到部分响应。
- 4：完成。已收到所有响应，可以使用了。  
每次readyState从一个值变成另一个值，都会触发readystatechange事件。可以借此机会检查readyState的值。一般来说，我们只关心readyState的值是4，表示数据已就绪。  
在收到响应之前如果想取消异步请求，可以调用abort()方法：
```
xhr.abort();
```
调用这个方法后，XHR对象会停止触发事件，并阻止访问这个对象上任何与响应相关的属性。中断请求后，应该取消对XHR对象的引用。由于内存问题，不推荐重用XHR对象。  
### HTTP头部
如果需要发送额外的请求头部，可以使用setRequestHeader()方法。这个方法接收两个参数：头部字段的名称和值。为保证请求头部被发送，必须在open()之后，send()之前调用setRequestHeader()。  
```
xhr.setRequestHeader('myHeader','myValue');
```
自定义头部一定要区别于浏览器正常发送的头部，否则可能影响服务器正常响应。  
可以使用getResponseHeader()方法从XHR对象获取响应头部，只要传入要获取头部的名称即可。如果想取得所有响应头部，可以使用getAllRequestHeaders()方法，这个方法会返回包含所有响应头部的字符串。
```
let myHeader = xhr.getRequestHeader('myHeader');
let allHeaders = xhr.getAllRequestHeaders();
```
### GET请求
